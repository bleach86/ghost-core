name: Build and Test Ghost Core

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-20.04

    strategy:
      matrix:
        os: [ubuntu-20.04]
        target: [x86_64-linux-gnu, x86_64-apple-darwin16, x86_64-w64-mingw32]
        include:
          - os: ubuntu-20.04
            target: x86_64-linux-gnu
            cache-key: ubuntu-deps
            deps: build-essential libtool autotools-dev automake pkg-config bsdmainutils curl git ca-certificates ccache libqt5gui5 libqt5core5a libqt5dbus5 qttools5-dev qttools5-dev-tools
          - os: ubuntu-20.04
            target: x86_64-apple-darwin16
            cache-key: macos-deps
            deps: build-essential libtool autotools-dev automake pkg-config bsdmainutils python3 git cmake pkg-config curl python3-setuptools librsvg2-bin libtiff-tools imagemagick libcap-dev libz-dev libbz2-dev libtinfo5 genisoimage
          - os: ubuntu-20.04
            target: x86_64-w64-mingw32
            cache-key: windows-deps
            deps: build-essential libtool autotools-dev automake pkg-config bsdmainutils curl git g++-mingw-w64-x86-64

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Cache apt dependencies
        uses: actions/cache@v2
        id: cache-apt
        with:
          path: ~/apt-cache
          key: apt-cache-${{ runner.os }}-${{ matrix.target }}

      - name: Install dependencies
        env:
          CACHE_HIT: ${{ steps.cache-apt.outputs.cache-hit }}
          DEPS: ${{ matrix.deps }}
        run: |
          if [[ "$CACHE_HIT" == 'true' ]]; then
            sudo rsync -a ~/apt-cache/ /
          else
            sudo apt-get update && sudo apt-get install -yq $DEPS
            mkdir -p ~/apt-cache
            for dep in $DEPS; do
              dpkg -L $dep | while IFS= read -r f; do if test -f "$f"; then echo $f; fi; done | xargs cp --parents --target-directory ~/apt-cache/ || true
            done
          fi

      - name: Cache dependencies
        id: cache-dependencies
        uses: actions/cache@v2
        with:
          path: depends/${{ matrix.target }}
          key: ${{ matrix.cache-key }}-${{ hashFiles('depends/packages/*.mk') }}

      - name: Download and set up custom macOS cross-compilation tools
        if: matrix.target == 'x86_64-apple-darwin16'
        run: |
          mkdir -p ~/SDKs
          cd ~/SDKs 
          curl -L -o mac-os-cross.tar.gz https://github.com/bleach86/ghost-build-tools/releases/download/v0.1.0/mac-os-cross.tar.gz
          tar -xzf mac-os-cross.tar.gz

      - name: Configure Windows toolchain
        if: matrix.target == 'x86_64-w64-mingw32'
        run: |
          sudo apt install -y g++-mingw-w64-x86-64
          sudo update-alternatives --install /usr/bin/x86_64-w64-mingw32-g++ x86_64-w64-mingw32-g++ /usr/bin/x86_64-w64-mingw32-g++-posix 10

      - name: Build dependencies
        run: |
          cd depends
          make HOST=${{ matrix.target }} SDK_PATH=~/SDKs/ -j$(nproc)

      - name: Refresh automake configs
        run: ./autogen.sh

      - name: Configure Ghost Core
        run: |
          CONFIG_SITE=$PWD/depends/${{ matrix.target }}/share/config.site ./configure --prefix=/

      - name: Build Ghost Core
        run: make -j$(nproc)

      - name: Package Ghost Core
        if: matrix.target == 'x86_64-apple-darwin16'
        run: make deploy

      - name: Upload test binary
        uses: actions/upload-artifact@v2
        with:
          name: test_ghost-${{ matrix.target }}
          path: src/test/test_ghost*

  test:
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Download test binary
        uses: actions/download-artifact@v2
        with:
          name: test_ghost-${{ matrix.target }}
          path: ./artifacts

      - name: Run tests on Linux
        if: matrix.os == 'ubuntu-latest'
        run: ./artifacts/test_ghost -l all

      - name: Run tests on macOS
        if: matrix.os == 'macos-latest'
        run: ./artifacts/test_ghost -l all

      - name: Run tests on Windows
        if: matrix.os == 'windows-latest'
        run: ./artifacts/test_ghost.exe -l all 
